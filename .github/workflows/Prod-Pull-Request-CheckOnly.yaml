name: "Salesforce JWT Authentication"

on:
  pull_request:
    branches:
      - main

jobs:
  jwt-auth-deployment:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: |
          npm install --global sfdx-cli
          sfdx --version

      - name: Create JWT Private Key File
        run: |
          echo "${{ secrets.SF_PRIVATE_KEY }}" > server.key

      - name: Authenticate with Salesforce via JWT
        run: |
          sfdx auth:jwt:grant \
            --client-id ${{ secrets.PROD_CONSUMER_KEY }} \
            --jwt-key-file ${{ secrets.JWT_SERVER_KEY }} \
            --username ${{ secrets.PROD_USER_ADMIN }} \
            --instance-url ${{ secrets.PROD_INSTANCE_URL }} \
            --setdefaultdevhubusername \
            --setalias my-dev-hub

      - name: Validate Deployment (Dry Run)
        run: |
          sfdx force:source:deploy -x manifest/Testpackage.xml \
            --testlevel RunSpecifiedTests --checkonly --json > result.json || echo "DEPLOY_FAILED=true" >> $GITHUB_ENV

      - name: Parse Test Results
        run: |
          TEST_RUN=$(jq -r '.result.details.runTestResult.numTestsRun' result.json)
          echo "Tests Run: $TEST_RUN"
          if [[ "$TEST_RUN" -eq "0" ]]; then
            echo "No tests were executed! Failing the job."
            exit 1
          fi
