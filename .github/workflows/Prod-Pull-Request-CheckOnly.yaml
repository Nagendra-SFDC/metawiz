name: "Salesforce Dry Run Deployment"

on:
  pull_request:
    branches:
      - main

jobs:
  dry-run-deployment:
    name: "Validate Deployment in Salesforce"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: |
          npm install --global sfdx-cli
          sfdx --version

      - name: Authenticate with Salesforce
        run: |
          echo ${{ secrets.SFDX_AUTH_URL }} > sfdx-auth.json
          sfdx auth:sfdxurl:store -f sfdx-auth.json --setdefaultdevhubusername --setalias my-dev-hub
          rm sfdx-auth.json

      - name: Validate Deployment (Dry Run) with Tests
        id: deploy
        run: |
          sfdx force:source:deploy -x manifest/package.xml \
            --testlevel RunSpecifiedTests --runtests "TestClass1,TestClass2" \
            --dryrun --json > result.json || echo "DEPLOY_FAILED=true" >> $GITHUB_ENV

      - name: Parse Test Results
        id: parse-tests
        run: |
          TEST_RUN=$(jq -r '.details.runTestResult.numTestsRun' result.json)
          echo "Tests Run: $TEST_RUN"
          if [[ "$TEST_RUN" -eq "0" ]]; then
            echo "No tests were executed! Failing the job."
            exit 1
          fi
          echo "tests_run=$TEST_RUN" >> $GITHUB_ENV

      - name: Comment on PR
        uses: mshick/add-pr-comment@v2
        if: always()
        with:
          message: |
            ğŸš€ **Salesforce Dry Run Completed**  
            - **Deployment Status**: ${{ env.DEPLOY_FAILED == 'true' && 'âŒ Failed' || 'âœ… Success' }}  
            - **Tests Run**: ${{ env.tests_run }}  
            - **Validation Only Mode**: âœ… (No changes applied)
