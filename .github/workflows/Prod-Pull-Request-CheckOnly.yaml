name: "Salesforce JWT Authentication"

on:
  pull_request:
    branches:
      - main

jobs:
  jwt-auth-deployment:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: |
          npm install --global sfdx-cli
          echo "Verifying CLI Installation..."
          sfdx --version
          sf --version || echo "sf command not found!"

      - name: Authenticate Salesforce
        run: |
          echo "${{ secrets.JWT_SERVER_KEY }}" | tr -d '\r' > server.key
          npx sf org login jwt \
            --username "${{ secrets.DEPLOYMENT_USER_NAME }}" \
            --jwt-key-file server.key \
            --client-id "${{ secrets.CONSUMER_KEY }}" \
            --instance-url "${{ secrets.INSTANCE_URL }}" \
            --set-default || { echo "Authentication failed!"; exit 1; }

      - name: Validate Deployment (Dry Run)
        run: |
          npx sfdx force:source:deploy -x manifest/Testpackage.xml \
            --testlevel RunSpecifiedTests --checkonly --json > result.json || echo "DEPLOY_FAILED=true" >> $GITHUB_ENV

      - name: Install jq (For JSON Parsing)
        run: sudo apt-get install -y jq

      - name: Parse Test Results
        run: |
          TEST_RUN=$(jq -r '.result.details.runTestResult.numTestsRun' result.json)
          echo "Tests Run: $TEST_RUN"
          if [[ "$TEST_RUN" -eq "0" ]]; then
            echo "No tests were executed! Failing the job."
            exit 1
          fi
